https详解---> 希望读完这篇文章，能比较详细地了解HTTPS。# 基础知识### 什么是HTTPS？`HTTPS`的全称是`Hypertext Transfer Protocol Secure`。从技术上来说，其实它本身并不是一个协议，而是在[`SSL/TLS`]协议的基础上使用[`HTTP`]协议，从而通过`SSL/TLS`来增加标准`HTTP`通讯的安全性。`HTTPS`的主要目的是为了防止[窃听——`wiretapping`](https://en.wikipedia.org/wiki/Wiretapping)，[会话劫持—— `session hijacking`](https://en.wikipedia.org/wiki/Session_hijacking)和[中间人攻击——`man-in-the-middle-attacks`](https://en.wikipedia.org/wiki/Man-in-the-middle_attack)。> 当然，在我朝，还有一个重要用途就是用来访问连接普通服务器时有问题的网站。### SSL的工作原理 SSL是为使用TCP/IP通讯的应用提供隐私和数据完整性保护的协议。Web浏览器使用的HTTP协议通过SSL来进行安全的通讯。客户端和服务器之间的传输数据使用了DES或者RC4等对称加密算法进行加密。公钥算法——通常为RSA——被用于加密秘钥和数字签名的交换。该算法用到了服务器端数字证书的公钥。有了服务器的数字证书，客户端也可以验证服务器的身份。SSL协议v1和v2版本只提供服务器验证。v3版通过在客户端和服务器都使用数字证书加入了客户端验证功能。### 可能发生的问题以下情况可能破坏HTTPS的安全性，需要<b style="color:red; font-size:1.125em">注意</b>：* 一些连接重定向到了普通地址（即URL协议部分不是`HTTPS`的地址）。* 网站的大部分脚本和CSS样式文件从HTTPS服务器加载，但是如果添加了连接到外部服务器的脚本或者CSS样式文件等资源文件，则存在破坏安全性的风险。* 性能问题：[`SSL`](https://en.wikipedia.org/wiki/Secure_Sockets_Layer)协议的开销，约1%的服务器CPU、流量、客户端CPU和第一次连接延迟。> HTTP、HTTPS性能比较> 首先，答案肯定是HTTP性能高，因为HTTPS相比HTTP需要做更多的事情。但是HTTPS具体比HTTP慢多少，还受到许多因素的影响。> HTTPS比HTTP慢的原因：初始握手（`handshake`）非常慢。握手实际传输的数据量并不大（基本上小于5kB），但是对于非常小的请求，这样的开销也是非常大的。但是，握手完成后，就会使用非常快速的对称加密，来尽量降低开销。但是底线是：通过HTTPS来发出许多短请求比HTTP慢，但是如果通过单个请求传输大量数据的话，差别不会很明显。> 不过，`HTTP/1.1`默认会`keepalive`（保持连接），因此只要做一次握手，以后的请求都会通过相同的连接来进行。这样可以显著减小HTTPS与HTTP的性能差别。（实际上握手的成本大约是每次会话至少`4-10x`，因为大部分浏览器会对相同的服务器使用多个连接。根据浏览器`https-keep-alive`的时间，一个会话可能会重复有多次握手）不过，现在的大部分服务器和浏览器，以及`SSL/TLS`实现都用到了会话重用，多个连接也会重用相同的`SSL`会话，因此，这也相对降低了HTTPS的开销。> 影响HTTPS和HTTP比较的因素主要包括：### SSL握手（SSL Handshake）基于HTTP的SSSL连接通过是由客户端通过使用以`https://`（而不是`http://`）开头的URL访问网站发起的。在SSL会话开始时，会执行一次`SSL handshake`（SSL 握手）。这次握手会生成会话的加密参数。下图展示了简化版的SSL握手流程：![](http://publib.boulder.ibm.com/tividd/td/ITAME/SC32-1363-00/en_US/HTML/handshak.gif)1.  客户端发送一条“Hello”信息，这条信息列出了客户端支持的加密（存储顺序按照客户端的优先级排列），例如SSL的版本，客户端支持的加密方法（`cipher suite`），以及客户端支持的数据压缩方法。除此之外，还包括一个28位的随机数字。2.  服务器响应“Hello”信息，内容包括：加密方法（`cipher suite`）、服务器选择的数据压缩方法，会话ID（`session` ID），以及另外一个随机数字。> <em style="color:red;">注意：</em>客户端和服务器共同支持至少一种加密方法(`cipher suite`)，否则握手会失败。服务器一般会选择最强的公有`cipher suite`。3.  服务器发送其数字证书（本例中，服务器使用`SSL`的`X.509 V3`数字证书）。    如果服务器使用`SSL V3`，而且服务器应用程序（例如，Web服务器）要求客户端使用数字证书进行验证，服务器会发送一条"`digital certificate request`"信息（即“数字证书请求”信息）。在这条信息中，服务器发送了它所支持的数字证书类型的列表，以及它所接受的数字证书权威机构的名称。4.  服务器发送一条“hello done”信息并等待客户端响应。5.  接收到服务器端的“hello done”信息后，客户端（Web浏览器）验证服务器数字证书的有效性，并且检查服务器的“hello”信息的参数是否是可接受的。6.  客户端发送一条“client key exchange”（即“客户端秘钥交换”）信息。这条信息包含了`pre-master`秘钥，用于生成对称加密秘钥生成的一个46位随机数，以及信息验证码（MAC）秘钥，均使用服务器的公钥进行了加密。    如果客户端发送了一个数字证书到服务器，客户端会发送一条使用客户端私钥签名的“digital certificate verify"（即“数字证书核实”）信息。通过核实这条信息的签名，服务器可以明确核实客户端数字证书的拥有权。    <em style="color: red;">注意：</em>如果不是必须的话，不需要附加流程来核实服务器数字证书。如果服务器没有该数字证书的私钥，它将无法解密`pre-master`秘钥，也不能创建正确地对称加密算法秘钥，从而导致握手失败。7.  客户端使用了一系列的加密操作来将`pre-master`秘钥转换成`master`秘钥，从而得到用于加密和信息验证的所有秘钥内容。然后客户端会发送一条“change cipher spec”（修改加密方法）信息来让服务器切换到刚刚协商好的加密方法。客户端发送的下一条信息（“finished”信息）是使用加密方法和秘钥机密过的第一条信息。8.  服务器用“a change cipher spec”以及自己的“finished”信息来进行响应。9.  SSL握手结束，开始发送加密后的应用数据。### 用途常见的几种HTTPS应用场景：* 防止窃听，防止抓取密码、cookie等敏感信息（例如，使用像[`Firesheep`](https://en.wikipedia.org/wiki/Firesheep)这样的工具）。公司网络、学校网络以及咖啡店等公共无线网络的窃听问题尤其严重。> 当然，如果只是抓密码的话，用`wireshark`也可以。* 一些用户的网络连接较差，会间歇性破坏字符。在编辑页面时可能会引发各种怪异的问题。大部分情况是连接到无线或手机网络。使用HTTPS可以修复这些问题，因为安全连接相对于普通连接有更好的错误检测机制。* 一些网络访问点（例如一些酒店或者咖啡厅的公用Wi-Fi）会在各种页面上注入广告，使用安全连接可以防止这样的问题。# 操作实践## HTTPS下的HTTP通讯## SPDY## HTTPS与前端开发## HTTPS与SEO## HTTPS服务器### 图片### 域名一个域名下承载了网站的大部分内容，主要包括图片、脚本、视频等。切换到HTTPS对这些内容会有什么影响？需要做出什么要的应对措施？* 例如淘宝的CDN有多个域名### 利用Node来代替Tengine实现多终端图片适配### 性能比较# 更多内容### 参考资料1.  [Http vs Https: What's the difference?](http://blogs.msdn.com/b/securitytipstalk/archive/2011/04/04/http-vs-https-what-s-the-difference.aspx)2.  [Wikipedia HTTP Secure英文](https://en.wikipedia.org/wiki/HTTP_Secure)3.  [Wikipedia HTTPS 中文](https://zh.wikipedia.org/wiki/HTTPS)4.  [Wikipedia:Secure_server](https://en.wikipedia.org/wiki/Wikipedia:Secure_server)5.  [HTTP vs HTTPS performance](https://stackoverflow.com/questions/149274/http-vs-https-performance)6.  [How much overhead dose SSL impose?](https://stackoverflow.com/questions/548029/how-much-overhead-does-ssl-impose)7.  [The SSL handshake](http://publib.boulder.ibm.com/tividd/td/ITAME/SC32-1363-00/en_US/HTML/ss7aumst18.htm)8.  [IBM SSL服务](http://publib.boulder.ibm.com/tividd/td/ITAME/SC32-1363-00/en_US/HTML/ss7aumst73.htm)9.  [msdn--TLS Handshake Protocol](http://msdn.microsoft.com/en-us/library/windows/desktop/aa380513(v=vs.85).aspx)10. <https://crypto.stackexchange.com/questions/1139/what-is-the-purpose-of-four-different-secrets-shared-by-client-and-server-in-ssl>### 规范[https-rfc2818](http://tools.ietf.org/html/rfc2818)[shttp-rfc2660](https://tools.ietf.org/html/rfc2660)### 部署了HTTPS的著名网站* [apple.com](https://www.apple.com)* [Wikipedia](https://www.wikipedia.org/)* [stackoverflow](https://stackoverflow.com/)### 相关概念`OCSP``CSP``how https works``https port``TLS``Firesheep``SPDY``DATA URI``Secure Domain``Secure Server``XSS``HTTPS Deployment``cihper suite``cipher suite explained``pre-master secret``oauth``HSTS``site: stackoverflow.com https``wireshark https``http1.0 http1.1 http2``curl https``wget https``site:youtube.com https``https vs ssl``https vs http performance``https vs http seo``p3p``http session hijacking``HTTP sidejacking``SSL/TLS``mand in the middle``ssl stripping``cors`### 扩展阅读* <https://developer.mozilla.org/en-US/docs/Web/Security>* <http://msdn.microsoft.com/en-us/library/cc838250(v=vs.95).aspx>* <http://mattandre.ws/2014/05/serviceworker-https-appcache-security/>* <http://www.chromium.org/sts>* <https://www.imperialviolet.org/2014/04/19/revchecking.html>* <https://www.imperialviolet.org/2014/06/20/boringssl.html>* <https://www.imperialviolet.org/2014/05/14/sha256.html>* [`SSL`](https://en.wikipedia.org/wiki/Secure_Sockets_Layer)* <https://stackoverflow.com/questions/548029/how-much-overhead-does-ssl-impose>* <https://code.google.com/p/https-finder/>* <http://www.gossamer-threads.com/lists/wiki/wikitech/232900>* <https://en.wikipedia.org/wiki/Firesheep>* <http://msdn.microsoft.com/en-us/library/aa767735(VS.85).aspx>* <https://en.wikipedia.org/wiki/Curl-loader>* <http://www.snopes.com/computer/internet/https.asp>* <http://www.webmonkey.com/2011/03/https-is-more-secure-why-isnt-the-web-using-it-today/>* <http://www.hoax-slayer.com/difference-http-https.shtml>* <http://serverfault.com/questions/43692/how-much-of-a-performance-hit-for-https-vs-http-for-apache>* <https://www.eff.org/>* <https://www.torproject.org/>* <https://www.facebook.com/notes/facebook/a-continued-commitment-to-security/486790652130>* <https://dvcs.w3.org/hg/cors/raw-file/tip/Overview.html>### 我们的工作例如detail页面（淘宝详情页）* 域名整理（各个资源的域名）